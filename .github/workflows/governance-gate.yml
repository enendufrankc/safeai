name: Governance Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  required-files:
    name: Required standards files
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Verify required pre-kickoff files exist
        shell: bash
        run: |
          set -euo pipefail
          required_files=(
            README.md
            GOVERNANCE.md
            MAINTAINERS.md
            CODE_OF_CONDUCT.md
            CONTRIBUTING.md
            SECURITY.md
            COMPATIBILITY.md
            .github/PULL_REQUEST_TEMPLATE.md
            .github/ISSUE_TEMPLATE/bug_report.yml
            .github/ISSUE_TEMPLATE/feature_request.yml
            .github/ISSUE_TEMPLATE/config.yml
            .github/dependabot.yml
            .github/required-checks.md
            .github/workflows/quality.yml
            schemas/v1alpha1/policy.schema.json
            schemas/v1alpha1/tool-contract.schema.json
            schemas/v1alpha1/memory.schema.json
          )

          missing=0
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing required file: $f"
              missing=1
            fi
          done

          if [ "$missing" -ne 0 ]; then
            echo "Governance gate failed: missing required files."
            exit 1
          fi

  schema-json-valid:
    name: Schema JSON validity
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate schema JSON syntax
        shell: bash
        run: |
          set -euo pipefail
          for f in schemas/v1alpha1/*.json; do
            echo "Validating $f"
            jq -e . "$f" >/dev/null
          done
